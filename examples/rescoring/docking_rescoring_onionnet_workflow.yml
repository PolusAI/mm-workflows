## Protein-ligand docking and docking poses re-ranking
##
## input: pdb structures from PDBbind refined dataset
## output: 
##    1. docking poses 
##    2. scoring file (vina score, sfct correction, combined_score for re-ranking docking poses)

steps:
#
- extract_pdbbind_refined:
    in:
      # https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.query.html
      # "The query() method uses a slightly modified Python syntax by default. 
      # For example, the & and | (bitwise) operators have the precedence of their boolean cousins, and and or. 
      # This is syntactically valid Python, however the semantics are different."
      query: '(Kd_Ki == "Kd") and (value < 0.000002)' 
        # to obtain a broader experimental dGs
      max_row: 1
      convert_Kd_dG: 'True'
      output_txt_path: '&binding_data.txt'
      output_pdb_paths: '&pdbbind_pdbs'
      output_sdf_paths: '&pdbbind_sdfs'
      experimental_dGs: '&exp_dGs' 

- fix_side_chain:
    scatter: [input_pdb_path]
    in:
      input_pdb_path: '*pdbbind_pdbs'
      output_pdb_path: '&pdbbind_pdbs.pdb'

- minimize_ligand_only.yml:
    scatter: [sdf_path]
    in:
      sdf_path: '*pdbbind_sdfs'

- smina_docking:
    scatter: [receptor_file, ligand_file, ligand_box]
    scatterMethod: dotproduct
    in:
      receptor_file: '*pdbbind_pdbs.pdb'
      ligand_file: '*ligand_min.mol2'
      ligand_box: '*ligand_min.mol2'
      scoring: 'vina'
      local_only: True
      output_dock_file: '&ligand_opt.pdb'
      output_path: output

- clean_smina_pdb:
    scatter: [input_pdb]
    in:
      input_pdb: '*ligand_opt.pdb'
      output_pdb: '&ligand_opt_clean.pdb'

- cat_pdb:
    scatter: [input_structure1, input_structure2]
    scatterMethod: dotproduct
    in:
      input_structure1: '*pdbbind_pdbs.pdb'
      input_structure2: '*ligand_opt_clean.pdb'
      output_structure_path: '&complex_pdbs.pdb'

- onionnet-feature:
    scatter: [complex_path_file]
    in:
      complex_path_file: '*complex_pdbs.pdb'
      output_feature_file: '&output_features.csv'
    
- onionnet-score:
    scatter: [input_feature_file]
    in:
      input_feature_file: '*output_features.csv'
      output_score_file: '&predicted_pKa.csv'
      onionnet_score: '&onionnet_score'

- scatter_plot:
    in:
      xs: '*exp_dGs'
      ys: '*onionnet_score'

wic:
  graphviz:
    label: Protein-ligand docking (Smina) and docking poses re-ranking (OnionNet-sfct)
  steps:
    (1, extract_pdbbind_refined):
      wic:
        graphviz:
          label: extract protein-ligand structure (protein.pdb and ligand.sdf) from pdbbind_refined dataset
    (2, fix_side_chain):
      wic:
        graphviz:
          label: fix_side_chain of protein structure.
    (3, minimize_ligand_only.yml):
      wic:
        inlineable: False
        graphviz:
          label: minimize (obminimize) ligand structure.
    (4, smina_docking):
      wic:
        graphviz:
          label: Smina docking (flexible ligand - rigid protein docking)